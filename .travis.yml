language: php

services:
  - mysql

addons:
  chrome: stable
  apt:
    packages:
      - dpkg
      - apache2
      - postfix
      - libapache2-mod-fastcgi
      - libappindicator1
      - fonts-liberation

cache:
  directories:
    - $HOME/.composer/cache

os: linux
dist: xenial

php:
  - 7.1
  - 7.3

env:
  global:
    - SYMFONY_DEPRECATIONS_HELPER=disabled
    - DISABLE_DEBUG_TOOLBAR=1
  jobs:
    - PRESTASHOP_TEST_TYPE=sanity

stages:
  - name: deploy
    if: type = cron

jobs:
  include:
    - stage: deploy
      php: 7.3
      before_install: skip
      before_script: skip
      install: skip
      script:
        - mkdir -p /tmp/ps-release
        - php tools/build/CreateRelease.php --destination-dir=/tmp/ps-release
        - cd /tmp/ps-release
          && today=`date +%Y-%m-%d-`; for i in *; do mv $i $today$TRAVIS_BRANCH-$i; done
          && cd -
      deploy:
        provider: gcs
        access_key_id: $GCS_ACCESS_KEY
        secret_access_key: $GCS_ACCESS_SECRET
        bucket: prestashop-core-nightly
        acl: public-read
        local_dir: "/tmp/ps-release"
        on:
          all_branches: true

before_install: skip

install: skip

script:
  - php -v

after_script: skip

after_failure: skip

before_deploy:
  - |
      mkdir -p ${HOME}/.ssh/;
      echo $GC_INSTANCE_KEY | base64 --decode -i > ${HOME}/.ssh/google_compute_engine && \
      echo $GC_INSTANCE_PUB | base64 --decode -i > ${HOME}/.ssh/google_compute_engine.pub && \
      chmod 600 ${HOME}/.ssh/* && \
      echo $GC_SERVICE_KEY | base64 --decode -i > ${HOME}/gcloud-service-key.json && \
      gcloud auth activate-service-account --key-file ${HOME}/gcloud-service-key.json && \
      gcloud config set project $GC_PROJECT_ID

after_deploy:
  - |
      [[ $TRAVIS_BRANCH = "develop" ]] && INSTANCE_TYPE="develop" || INSTANCE_TYPE="release";
      # make sure instance is stopped. This step does not need to be chained
      gcloud compute instances stop --zone $GC_ZONE "${GC_INSTANCE_NAME}-${INSTANCE_TYPE}";
      gcloud compute instances add-metadata "${GC_INSTANCE_NAME}-${INSTANCE_TYPE}" --zone $GC_ZONE --metadata=NIGHTLY_TOKEN=$NIGHTLY_TOKEN && \
      gcloud compute instances add-metadata "${GC_INSTANCE_NAME}-${INSTANCE_TYPE}" --zone $GC_ZONE --metadata=TRAVIS_BRANCH=$TRAVIS_BRANCH && \
      gcloud compute instances add-metadata "${GC_INSTANCE_NAME}-${INSTANCE_TYPE}" --zone $GC_ZONE --metadata-from-file startup-tests-script=tests/UI/scripts/run-nightly-tests.sh && \
      gcloud compute instances add-metadata "${GC_INSTANCE_NAME}-${INSTANCE_TYPE}" --zone $GC_ZONE --metadata-from-file startup-reports-script=tests/UI/scripts/run-nightly-reports.sh && \
      gcloud compute instances start --zone $GC_ZONE "${GC_INSTANCE_NAME}-${INSTANCE_TYPE}"
